name: Windows_MinGW

on: [push]
  #schedule:
#  - cron:  '0 5 * * *'  #daily build at 5AM
jobs:
  Windows_MinGW:

    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v1
      # Manual setup
      #- name: Install msys2/mingw64
      #  #steps from https://github.com/msys2/MINGW-packages/blob/master/azure-pipelines.yml
      #  run: |
      #    git clone https://github.com/msys2/msys2-ci-base.git D:\msys64 # they removed this repo :(
      #    D:\msys64\usr\bin\rm -rf D:\msys64\.git
      #    set PATH=D:\msys64\usr\bin;%WINDIR%;%WINDIR%\System32
      #    D:\msys64\usr\bin\pacman --noconfirm -Syyuu
      #    set PATH=D:\msys64\usr\bin;%WINDIR%;%WINDIR%\System32
      #    D:\msys64\usr\bin\pacman --noconfirm --needed -S git base-devel
      #    D:\msys64\usr\bin\pacman --noconfirm -Scc
      #  shell: cmd
      - uses: msys2/setup-msys2@v2
      - name: Install required msys2/mingw64 packages
        run: |
          pacman -S --noconfirm unzip
          pacman -S --noconfirm tar
          pacman -S --noconfirm mingw-w64-x86_64-curl
          pacman -S --noconfirm mingw-w64-x86_64-binutils
          pacman -S --noconfirm mingw-w64-x86_64-boost
          pacman -S --noconfirm mingw-w64-x86_64-cmake
          pacman -S --noconfirm mingw-w64-x86_64-gcc
          pacman -S --noconfirm mingw-w64-x86_64-ninja
          pacman -S --noconfirm mingw-w64-x86_64-gcc-libs
          pacman -S --noconfirm mingw-w64-x86_64-gcc-objc
          pacman -S --noconfirm mingw-w64-x86_64-gdb
          pacman -S --noconfirm mingw-w64-x86_64-make
          pacman -S --noconfirm mingw-w64-x86_64-python
          pacman -S --noconfirm mingw-w64-x86_64-ccache
          pacman --noconfirm -Scc
      - name: Configure CMake
        run: |
          mkdir cmake-cache
          cd cmake-cache
          cmake -DCMAKE_BUILD_TYPE=minsizerel -DNS3_EXAMPLES=ON -DNS3_TESTS=ON -G"Ninja" -DAUTOINSTALL_DEPENDENCIES=ON ..
      - name: Build ns-3
        run: |
          cd cmake-cache
          ninja 
      - name: Run tests
        run: python ./utils/test-runner-script.py
      - name: Run examples
        run : |
          cd cmake-cache
          ctest -j 4 --timeout 800